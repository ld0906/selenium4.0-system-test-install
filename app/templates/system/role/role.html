<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>角色管理</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet"/>
    <link href="{{ url_for('static', filename='css/font-awesome.min.css') }}" rel="stylesheet"/>
    <style>
        body { padding: 20px; background: white; }
        .search-box { background: #f3f3f4; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        .btn-toolbar { margin-bottom: 15px; }
        table { background: white; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h3><i class="fa fa-user-circle-o"></i> 角色管理</h3>
        
        <!-- 搜索区域 -->
        <div class="search-box">
            <form id="searchForm" class="form-inline">
                <div class="form-group">
                    <label>角色名称：</label>
                    <input type="text" name="roleName" class="form-control" placeholder="请输入角色名称">
                </div>
                <div class="form-group" style="margin-left: 10px;">
                    <label>权限字符：</label>
                    <input type="text" name="roleKey" class="form-control" placeholder="请输入权限字符">
                </div>
                <div class="form-group" style="margin-left: 10px;">
                    <label>状态：</label>
                    <select name="status" class="form-control">
                        <option value="">全部</option>
                        <option value="0">正常</option>
                        <option value="1">停用</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary" onclick="searchData()" style="margin-left: 10px;">
                    <i class="fa fa-search"></i> 查询
                </button>
                <button type="button" class="btn btn-default" onclick="resetSearch()">
                    <i class="fa fa-refresh"></i> 重置
                </button>
            </form>
        </div>

        <!-- 工具栏 -->
        <div class="btn-toolbar">
            <button type="button" class="btn btn-success" onclick="addRole()">
                <i class="fa fa-plus"></i> 新增
            </button>
            <button type="button" class="btn btn-danger" onclick="batchDelete()">
                <i class="fa fa-trash"></i> 删除
            </button>
        </div>

        <!-- 数据表格 -->
        <table class="table table-striped table-bordered table-hover" id="roleTable">
            <thead>
                <tr>
                    <th width="5%"><input type="checkbox" onclick="selectAll(this)"></th>
                    <th width="8%">角色ID</th>
                    <th width="15%">角色名称</th>
                    <th width="15%">权限字符</th>
                    <th width="8%">显示顺序</th>
                    <th width="10%">状态</th>
                    <th width="15%">创建时间</th>
                    <th width="24%">操作</th>
                </tr>
            </thead>
            <tbody id="roleTableBody">
                <tr>
                    <td colspan="8" class="text-center">加载中...</td>
                </tr>
            </tbody>
        </table>

        <!-- 分页 -->
        <div id="pagination" class="text-center"></div>
    </div>

    <!-- 新增/编辑对话框 -->
    <div class="modal fade" id="roleModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                    <h4 class="modal-title" id="modalTitle">新增角色</h4>
                </div>
                <div class="modal-body">
                    <form id="roleForm">
                        <input type="hidden" name="roleId" id="roleId">
                        <div class="form-group">
                            <label>角色名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="roleName" id="roleName" required>
                        </div>
                        <div class="form-group">
                            <label>权限字符 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="roleKey" id="roleKey" required>
                        </div>
                        <div class="form-group">
                            <label>显示排序</label>
                            <input type="number" class="form-control" name="roleSort" id="roleSort" value="0">
                        </div>
                        <div class="form-group">
                            <label>状态</label>
                            <select class="form-control" name="status" id="statusSelect">
                                <option value="0">正常</option>
                                <option value="1">停用</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>备注</label>
                            <textarea class="form-control" name="remark" id="remark" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitForm()">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script>
        var currentPage = 1;
        var pageSize = 10;

        $(function() {
            loadData();
        });

        function loadData() {
            var params = $('#searchForm').serialize();
            params += '&pageNum=' + currentPage + '&pageSize=' + pageSize;

            $.ajax({
                url: '/system/role/list/data',
                type: 'GET',
                data: params,
                success: function(res) {
                    if (res.code == 0) {
                        renderTable(res.rows || []);
                        renderPagination(res.total || 0);
                    } else {
                        alert('加载数据失败：' + res.msg);
                    }
                }
            });
        }

        function renderTable(rows) {
            var html = '';
            if (rows.length == 0) {
                html = '<tr><td colspan="8" class="text-center">暂无数据</td></tr>';
            } else {
                rows.forEach(function(row) {
                    var statusText = row.status == '0' ? 
                        '<span class="label label-success">正常</span>' : 
                        '<span class="label label-danger">停用</span>';
                    
                    html += '<tr>';
                    html += '<td><input type="checkbox" value="' + row.role_id + '"></td>';
                    html += '<td>' + row.role_id + '</td>';
                    html += '<td>' + row.role_name + '</td>';
                    html += '<td>' + row.role_key + '</td>';
                    html += '<td>' + row.role_sort + '</td>';
                    html += '<td>' + statusText + '</td>';
                    html += '<td>' + row.create_time + '</td>';
                    html += '<td>';
                    html += '<button class="btn btn-xs btn-success" onclick="dataScope(' + row.role_id + ')"><i class="fa fa-check-circle-o"></i> 数据权限</button> ';
                    html += '<button class="btn btn-xs btn-info" onclick="editRole(' + row.role_id + ')"><i class="fa fa-edit"></i> 修改</button> ';
                    html += '<button class="btn btn-xs btn-danger" onclick="deleteRole(' + row.role_id + ')"><i class="fa fa-trash"></i> 删除</button>';
                    html += '</td>';
                    html += '</tr>';
                });
            }
            $('#roleTableBody').html(html);
        }

        function renderPagination(total) {
            var totalPages = Math.ceil(total / pageSize);
            var html = '';
            
            if (totalPages > 1) {
                html += '<ul class="pagination">';
                
                // 上一页
                if (currentPage > 1) {
                    html += '<li><a href="javascript:void(0)" onclick="changePage(' + (currentPage - 1) + ')">上一页</a></li>';
                } else {
                    html += '<li class="disabled"><span>上一页</span></li>';
                }
                
                // 页码
                for (var i = 1; i <= totalPages; i++) {
                    if (i == currentPage) {
                        html += '<li class="active"><span>' + i + '</span></li>';
                    } else {
                        html += '<li><a href="javascript:void(0)" onclick="changePage(' + i + ')">' + i + '</a></li>';
                    }
                }
                
                // 下一页
                if (currentPage < totalPages) {
                    html += '<li><a href="javascript:void(0)" onclick="changePage(' + (currentPage + 1) + ')">下一页</a></li>';
                } else {
                    html += '<li class="disabled"><span>下一页</span></li>';
                }
                
                html += '</ul>';
            }
            
            $('#pagination').html(html);
        }

        function changePage(page) {
            currentPage = page;
            loadData();
        }

        function searchData() {
            currentPage = 1;
            loadData();
        }

        function resetSearch() {
            $('#searchForm')[0].reset();
            currentPage = 1;
            loadData();
        }

        function selectAll(checkbox) {
            $('#roleTableBody input[type="checkbox"]').prop('checked', checkbox.checked);
        }

        function addRole() {
            $('#modalTitle').text('新增角色');
            $('#roleForm')[0].reset();
            $('#roleId').val('');
            $('#roleModal').modal('show');
        }

        function editRole(roleId) {
            $('#modalTitle').text('编辑角色');
            
            $.ajax({
                url: '/system/role/list/data',
                type: 'GET',
                success: function(res) {
                    if (res.code == 0) {
                        var role = res.rows.find(function(r) { return r.role_id == roleId; });
                        if (role) {
                            $('#roleId').val(role.role_id);
                            $('#roleName').val(role.role_name);
                            $('#roleKey').val(role.role_key);
                            $('#roleSort').val(role.role_sort);
                            $('#statusSelect').val(role.status);
                            $('#roleModal').modal('show');
                        }
                    }
                }
            });
        }

        function submitForm() {
            var roleId = $('#roleId').val();
            var url = roleId ? '/system/role/edit' : '/system/role/add';
            
            $.ajax({
                url: url,
                type: 'POST',
                data: $('#roleForm').serialize(),
                success: function(res) {
                    if (res.code == 0) {
                        alert(res.msg);
                        $('#roleModal').modal('hide');
                        loadData();
                    } else {
                        alert(res.msg);
                    }
                }
            });
        }

        function deleteRole(roleId) {
            if (confirm('确定要删除该角色吗？')) {
                $.ajax({
                    url: '/system/role/remove',
                    type: 'POST',
                    data: { ids: roleId },
                    success: function(res) {
                        if (res.code == 0) {
                            alert(res.msg);
                            loadData();
                        } else {
                            alert(res.msg);
                        }
                    }
                });
            }
        }

        function batchDelete() {
            var ids = [];
            $('#roleTableBody input[type="checkbox"]:checked').each(function() {
                ids.push($(this).val());
            });
            
            if (ids.length == 0) {
                alert('请至少选择一条数据');
                return;
            }
            
            if (confirm('确定要删除选中的 ' + ids.length + ' 条数据吗？')) {
                $.ajax({
                    url: '/system/role/remove',
                    type: 'POST',
                    data: { ids: ids.join(',') },
                    success: function(res) {
                        if (res.code == 0) {
                            alert(res.msg);
                            loadData();
                        } else {
                            alert(res.msg);
                        }
                    }
                });
            }
        }

        function dataScope(roleId) {
            alert('数据权限设置功能开发中... 角色ID: ' + roleId);
        }
    </script>
</body>
</html>
