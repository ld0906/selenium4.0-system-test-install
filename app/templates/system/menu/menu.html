<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>菜单管理</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet"/>
    <link href="{{ url_for('static', filename='css/font-awesome.min.css') }}" rel="stylesheet"/>
    <style>
        body { padding: 20px; background: white; }
        .search-box { background: #f3f3f4; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        .btn-toolbar { margin-bottom: 15px; }
        table { background: white; }
        .tree-table { width: 100%; }
        .tree-table td { padding: 8px; }
        .tree-indent { display: inline-block; width: 20px; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h3><i class="fa fa-list-ul"></i> 菜单管理</h3>
        
        <!-- 搜索区域 -->
        <div class="search-box">
            <form id="searchForm" class="form-inline">
                <div class="form-group">
                    <label>菜单名称：</label>
                    <input type="text" name="menuName" class="form-control" placeholder="请输入菜单名称">
                </div>
                <div class="form-group" style="margin-left: 10px;">
                    <label>状态：</label>
                    <select name="status" class="form-control">
                        <option value="">全部</option>
                        <option value="0">正常</option>
                        <option value="1">停用</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary" onclick="searchData()" style="margin-left: 10px;">
                    <i class="fa fa-search"></i> 查询
                </button>
                <button type="button" class="btn btn-default" onclick="resetSearch()">
                    <i class="fa fa-refresh"></i> 重置
                </button>
            </form>
        </div>

        <!-- 工具栏 -->
        <div class="btn-toolbar">
            <button type="button" class="btn btn-success" onclick="addMenu()">
                <i class="fa fa-plus"></i> 新增
            </button>
            <button type="button" class="btn btn-info" onclick="expandAll()">
                <i class="fa fa-expand"></i> 展开全部
            </button>
            <button type="button" class="btn btn-info" onclick="collapseAll()">
                <i class="fa fa-compress"></i> 折叠全部
            </button>
        </div>

        <!-- 数据表格 -->
        <table class="table table-striped table-bordered table-hover tree-table" id="menuTable">
            <thead>
                <tr>
                    <th width="30%">菜单名称</th>
                    <th width="8%">图标</th>
                    <th width="10%">类型</th>
                    <th width="10%">排序</th>
                    <th width="15%">权限标识</th>
                    <th width="12%">状态</th>
                    <th width="15%">操作</th>
                </tr>
            </thead>
            <tbody id="menuTableBody">
                <tr>
                    <td colspan="7" class="text-center">加载中...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 新增/编辑对话框 -->
    <div class="modal fade" id="menuModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                    <h4 class="modal-title" id="modalTitle">新增菜单</h4>
                </div>
                <div class="modal-body">
                    <form id="menuForm">
                        <input type="hidden" name="menuId" id="menuId">
                        <input type="hidden" name="parentId" id="parentId" value="0">
                        <div class="form-group">
                            <label>上级菜单</label>
                            <input type="text" class="form-control" id="parentName" readonly>
                        </div>
                        <div class="form-group">
                            <label>菜单类型 <span class="text-danger">*</span></label>
                            <select class="form-control" name="menuType" id="menuType" required>
                                <option value="M">目录</option>
                                <option value="C">菜单</option>
                                <option value="F">按钮</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>菜单名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="menuName" id="menuName" required>
                        </div>
                        <div class="form-group">
                            <label>显示排序</label>
                            <input type="number" class="form-control" name="orderNum" id="orderNum" value="0">
                        </div>
                        <div class="form-group" id="urlGroup">
                            <label>路由地址</label>
                            <input type="text" class="form-control" name="url" id="url" placeholder="如：/system/user">
                        </div>
                        <div class="form-group">
                            <label>权限标识</label>
                            <input type="text" class="form-control" name="perms" id="perms" placeholder="如：system:user:view">
                        </div>
                        <div class="form-group" id="iconGroup">
                            <label>菜单图标</label>
                            <input type="text" class="form-control" name="icon" id="icon" placeholder="如：fa fa-user">
                        </div>
                        <div class="form-group">
                            <label>显示状态</label>
                            <select class="form-control" name="visible" id="visible">
                                <option value="0">显示</option>
                                <option value="1">隐藏</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>菜单状态</label>
                            <select class="form-control" name="status" id="statusSelect">
                                <option value="0">正常</option>
                                <option value="1">停用</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitForm()">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script>
        var menuData = [];

        $(function() {
            loadData();
            
            // 监听菜单类型变化
            $('#menuType').change(function() {
                var type = $(this).val();
                if (type == 'F') {
                    $('#urlGroup').hide();
                    $('#iconGroup').hide();
                } else {
                    $('#urlGroup').show();
                    $('#iconGroup').show();
                }
            });
        });

        function loadData() {
            $.ajax({
                url: '/system/menu/tree',
                type: 'GET',
                success: function(res) {
                    if (res.code == 0) {
                        menuData = res.data || [];
                        renderTable(menuData);
                    } else {
                        alert('加载数据失败：' + res.msg);
                    }
                }
            });
        }

        function renderTable(data) {
            var html = '';
            if (data.length == 0) {
                html = '<tr><td colspan="7" class="text-center">暂无数据</td></tr>';
            } else {
                html = renderTreeRows(data, 0);
            }
            $('#menuTableBody').html(html);
        }

        function renderTreeRows(nodes, level) {
            var html = '';
            nodes.forEach(function(node) {
                var statusText = node.status == '0' ? 
                    '<span class="label label-success">正常</span>' : 
                    '<span class="label label-danger">停用</span>';
                
                var typeText = node.menu_type == 'M' ? '目录' : (node.menu_type == 'C' ? '菜单' : '按钮');
                var typeClass = node.menu_type == 'M' ? 'primary' : (node.menu_type == 'C' ? 'success' : 'info');
                
                var indent = '';
                for (var i = 0; i < level; i++) {
                    indent += '<span class="tree-indent"></span>';
                }
                
                html += '<tr data-id="' + node.menu_id + '" data-level="' + level + '">';
                html += '<td>' + indent;
                if (node.children && node.children.length > 0) {
                    html += '<i class="fa fa-minus-square-o tree-toggle" onclick="toggleRow(this)"></i> ';
                } else {
                    html += '<i class="fa fa-file-o"></i> ';
                }
                html += node.menu_name + '</td>';
                html += '<td><i class="fa ' + (node.icon || '') + '"></i></td>';
                html += '<td><span class="label label-' + typeClass + '">' + typeText + '</span></td>';
                html += '<td>' + node.order_num + '</td>';
                html += '<td><small>' + (node.perms || '') + '</small></td>';
                html += '<td>' + statusText + '</td>';
                html += '<td>';
                html += '<button class="btn btn-xs btn-success" onclick="addChildMenu(' + node.menu_id + ')"><i class="fa fa-plus"></i> 新增</button> ';
                html += '<button class="btn btn-xs btn-info" onclick="editMenu(' + node.menu_id + ')"><i class="fa fa-edit"></i> 修改</button> ';
                html += '<button class="btn btn-xs btn-danger" onclick="deleteMenu(' + node.menu_id + ')"><i class="fa fa-trash"></i> 删除</button>';
                html += '</td>';
                html += '</tr>';
                
                if (node.children && node.children.length > 0) {
                    html += renderTreeRows(node.children, level + 1);
                }
            });
            return html;
        }

        function toggleRow(icon) {
            var $icon = $(icon);
            var $row = $icon.closest('tr');
            var level = parseInt($row.attr('data-level'));
            var $nextRows = $row.nextAll('tr');
            
            var isCollapse = $icon.hasClass('fa-minus-square-o');
            
            $nextRows.each(function() {
                var $nextRow = $(this);
                var nextLevel = parseInt($nextRow.attr('data-level'));
                
                if (nextLevel <= level) {
                    return false;
                }
                
                if (nextLevel == level + 1) {
                    $nextRow.toggle(!isCollapse);
                } else if (nextLevel > level + 1) {
                    if (isCollapse) {
                        $nextRow.hide();
                    }
                }
            });
            
            if (isCollapse) {
                $icon.removeClass('fa-minus-square-o').addClass('fa-plus-square-o');
            } else {
                $icon.removeClass('fa-plus-square-o').addClass('fa-minus-square-o');
            }
        }

        function expandAll() {
            $('#menuTableBody tr').show();
            $('.tree-toggle').removeClass('fa-plus-square-o').addClass('fa-minus-square-o');
        }

        function collapseAll() {
            $('#menuTableBody tr').each(function() {
                var level = parseInt($(this).attr('data-level'));
                if (level > 0) {
                    $(this).hide();
                }
            });
            $('.tree-toggle').removeClass('fa-minus-square-o').addClass('fa-plus-square-o');
        }

        function searchData() {
            var menuName = $('input[name="menuName"]').val();
            var status = $('select[name="status"]').val();
            
            var filtered = filterMenus(menuData, menuName, status);
            renderTable(filtered);
        }

        function filterMenus(menus, name, status) {
            var result = [];
            menus.forEach(function(menu) {
                var match = true;
                if (name && menu.menu_name.indexOf(name) == -1) {
                    match = false;
                }
                if (status && menu.status != status) {
                    match = false;
                }
                
                if (match) {
                    result.push(menu);
                } else if (menu.children && menu.children.length > 0) {
                    var childResult = filterMenus(menu.children, name, status);
                    if (childResult.length > 0) {
                        var newMenu = Object.assign({}, menu);
                        newMenu.children = childResult;
                        result.push(newMenu);
                    }
                }
            });
            return result;
        }

        function resetSearch() {
            $('#searchForm')[0].reset();
            renderTable(menuData);
        }

        function addMenu() {
            $('#modalTitle').text('新增菜单');
            $('#menuForm')[0].reset();
            $('#menuId').val('');
            $('#parentId').val('0');
            $('#parentName').val('无');
            $('#urlGroup').show();
            $('#iconGroup').show();
            $('#menuModal').modal('show');
        }

        function addChildMenu(parentId) {
            $('#modalTitle').text('新增子菜单');
            $('#menuForm')[0].reset();
            $('#menuId').val('');
            $('#parentId').val(parentId);
            
            var parentName = findMenuName(menuData, parentId);
            $('#parentName').val(parentName);
            $('#urlGroup').show();
            $('#iconGroup').show();
            $('#menuModal').modal('show');
        }

        function findMenuName(menus, menuId) {
            for (var i = 0; i < menus.length; i++) {
                if (menus[i].menu_id == menuId) {
                    return menus[i].menu_name;
                }
                if (menus[i].children && menus[i].children.length > 0) {
                    var name = findMenuName(menus[i].children, menuId);
                    if (name) return name;
                }
            }
            return '';
        }

        function editMenu(menuId) {
            $('#modalTitle').text('编辑菜单');
            
            var menu = findMenu(menuData, menuId);
            if (menu) {
                $('#menuId').val(menu.menu_id);
                $('#parentId').val(menu.parent_id);
                $('#parentName').val(menu.parent_id == 0 ? '无' : findMenuName(menuData, menu.parent_id));
                $('#menuType').val(menu.menu_type);
                $('#menuName').val(menu.menu_name);
                $('#orderNum').val(menu.order_num);
                $('#url').val(menu.url || '');
                $('#perms').val(menu.perms || '');
                $('#icon').val(menu.icon || '');
                $('#visible').val(menu.visible);
                $('#statusSelect').val(menu.status);
                
                if (menu.menu_type == 'F') {
                    $('#urlGroup').hide();
                    $('#iconGroup').hide();
                } else {
                    $('#urlGroup').show();
                    $('#iconGroup').show();
                }
                
                $('#menuModal').modal('show');
            }
        }

        function findMenu(menus, menuId) {
            for (var i = 0; i < menus.length; i++) {
                if (menus[i].menu_id == menuId) {
                    return menus[i];
                }
                if (menus[i].children && menus[i].children.length > 0) {
                    var menu = findMenu(menus[i].children, menuId);
                    if (menu) return menu;
                }
            }
            return null;
        }

        function submitForm() {
            var menuId = $('#menuId').val();
            var url = menuId ? '/system/menu/edit' : '/system/menu/add';
            
            $.ajax({
                url: url,
                type: 'POST',
                data: $('#menuForm').serialize(),
                success: function(res) {
                    if (res.code == 0) {
                        alert(res.msg);
                        $('#menuModal').modal('hide');
                        loadData();
                    } else {
                        alert(res.msg);
                    }
                }
            });
        }

        function deleteMenu(menuId) {
            if (confirm('确定要删除该菜单吗？')) {
                $.ajax({
                    url: '/system/menu/remove/' + menuId,
                    type: 'POST',
                    success: function(res) {
                        if (res.code == 0) {
                            alert(res.msg);
                            loadData();
                        } else {
                            alert(res.msg);
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
