<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>岗位管理</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet"/>
    <link href="{{ url_for('static', filename='css/font-awesome.min.css') }}" rel="stylesheet"/>
    <style>
        body { padding: 20px; background: white; }
        .search-box { background: #f3f3f4; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        .btn-toolbar { margin-bottom: 15px; }
        table { background: white; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h3><i class="fa fa-id-card-o"></i> 岗位管理</h3>
        
        <!-- 搜索区域 -->
        <div class="search-box">
            <form id="searchForm" class="form-inline">
                <div class="form-group">
                    <label>岗位名称：</label>
                    <input type="text" name="postName" class="form-control" placeholder="请输入岗位名称">
                </div>
                <div class="form-group" style="margin-left: 10px;">
                    <label>状态：</label>
                    <select name="status" class="form-control">
                        <option value="">全部</option>
                        <option value="0">正常</option>
                        <option value="1">停用</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary" onclick="searchData()" style="margin-left: 10px;">
                    <i class="fa fa-search"></i> 查询
                </button>
                <button type="button" class="btn btn-default" onclick="resetSearch()">
                    <i class="fa fa-refresh"></i> 重置
                </button>
            </form>
        </div>

        <!-- 工具栏 -->
        <div class="btn-toolbar">
            <button type="button" class="btn btn-success" onclick="addPost()">
                <i class="fa fa-plus"></i> 新增
            </button>
        </div>

        <!-- 数据表格 -->
        <table class="table table-striped table-bordered table-hover" id="postTable">
            <thead>
                <tr>
                    <th width="10%">岗位ID</th>
                    <th width="20%">岗位编码</th>
                    <th width="20%">岗位名称</th>
                    <th width="10%">排序</th>
                    <th width="15%">状态</th>
                    <th width="25%">操作</th>
                </tr>
            </thead>
            <tbody id="postTableBody">
                <tr><td colspan="6" class="text-center">加载中...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- 新增/编辑对话框 -->
    <div class="modal fade" id="postModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                    <h4 class="modal-title" id="modalTitle">新增岗位</h4>
                </div>
                <div class="modal-body">
                    <form id="postForm">
                        <input type="hidden" name="postId" id="postId">
                        <div class="form-group">
                            <label>岗位编码 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="postCode" id="postCode" required>
                        </div>
                        <div class="form-group">
                            <label>岗位名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="postName" id="postName" required>
                        </div>
                        <div class="form-group">
                            <label>显示排序</label>
                            <input type="number" class="form-control" name="postSort" id="postSort" value="0">
                        </div>
                        <div class="form-group">
                            <label>状态</label>
                            <select class="form-control" name="status" id="status">
                                <option value="0">正常</option>
                                <option value="1">停用</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>备注</label>
                            <textarea class="form-control" name="remark" id="remark" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitForm()">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script>
        var currentPage = 1;
        var pageSize = 10;

        $(function() { loadData(); });

        function loadData() {
            var params = $('#searchForm').serialize();
            params += '&pageNum=' + currentPage + '&pageSize=' + pageSize;

            $.ajax({
                url: '/system/post/list/data',
                type: 'GET',
                data: params,
                success: function(res) {
                    if (res.code == 0) {
                        renderTable(res.rows || []);
                        renderPagination(res.total || 0);
                    } else {
                        alert('加载数据失败：' + res.msg);
                    }
                }
            });
        }

        function renderTable(rows) {
            var html = '';
            if (rows.length == 0) {
                html = '<tr><td colspan="6" class="text-center">暂无数据</td></tr>';
            } else {
                rows.forEach(function(row) {
                    var statusText = row.status == '0' ? 
                        '<span class="label label-success">正常</span>' : 
                        '<span class="label label-danger">停用</span>';
                    
                    html += '<tr>';
                    html += '<td>' + row.post_id + '</td>';
                    html += '<td>' + row.post_code + '</td>';
                    html += '<td>' + row.post_name + '</td>';
                    html += '<td>' + row.post_sort + '</td>';
                    html += '<td>' + statusText + '</td>';
                    html += '<td>';
                    html += '<button class="btn btn-xs btn-info" onclick="editPost(' + row.post_id + ')"><i class="fa fa-edit"></i> 修改</button> ';
                    html += '<button class="btn btn-xs btn-danger" onclick="deletePost(' + row.post_id + ')"><i class="fa fa-trash"></i> 删除</button>';
                    html += '</td>';
                    html += '</tr>';
                });
            }
            $('#postTableBody').html(html);
        }

        function renderPagination(total) {
            var totalPages = Math.ceil(total / pageSize);
            var html = '';
            
            if (totalPages > 1) {
                html += '<ul class="pagination">';
                if (currentPage > 1) {
                    html += '<li><a href="javascript:void(0)" onclick="changePage(' + (currentPage - 1) + ')">上一页</a></li>';
                }
                for (var i = 1; i <= totalPages; i++) {
                    html += '<li' + (i == currentPage ? ' class="active"' : '') + '><a href="javascript:void(0)" onclick="changePage(' + i + ')">' + i + '</a></li>';
                }
                if (currentPage < totalPages) {
                    html += '<li><a href="javascript:void(0)" onclick="changePage(' + (currentPage + 1) + ')">下一页</a></li>';
                }
                html += '</ul>';
            }
            $('#pagination').html(html);
        }

        function changePage(page) {
            currentPage = page;
            loadData();
        }

        function searchData() {
            currentPage = 1;
            loadData();
        }

        function resetSearch() {
            $('#searchForm')[0].reset();
            currentPage = 1;
            loadData();
        }

        function addPost() {
            $('#modalTitle').text('新增岗位');
            $('#postForm')[0].reset();
            $('#postId').val('');
            $('#postModal').modal('show');
        }

        function editPost(postId) {
            $('#modalTitle').text('编辑岗位');
            
            // 从表格中获取数据
            $.ajax({
                url: '/system/post/list/data',
                type: 'GET',
                success: function(res) {
                    if (res.code == 0) {
                        var post = res.rows.find(function(p) { return p.post_id == postId; });
                        if (post) {
                            $('#postId').val(post.post_id);
                            $('#postCode').val(post.post_code);
                            $('#postName').val(post.post_name);
                            $('#postSort').val(post.post_sort);
                            $('#status').val(post.status);
                            $('#postModal').modal('show');
                        }
                    }
                }
            });
        }

        function submitForm() {
            var postId = $('#postId').val();
            var url = postId ? '/system/post/edit' : '/system/post/add';
            
            $.ajax({
                url: url,
                type: 'POST',
                data: $('#postForm').serialize(),
                success: function(res) {
                    if (res.code == 0) {
                        alert(res.msg);
                        $('#postModal').modal('hide');
                        loadData();
                    } else {
                        alert(res.msg);
                    }
                }
            });
        }

        function deletePost(postId) {
            if (confirm('确定要删除该岗位吗？')) {
                $.ajax({
                    url: '/system/post/remove',
                    type: 'POST',
                    data: { ids: postId },
                    success: function(res) {
                        if (res.code == 0) {
                            alert(res.msg);
                            loadData();
                        } else {
                            alert(res.msg);
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
